name: Deploy Go Backend
on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  APP_NAME: isfapp  # Must match your Terraform var.app_name

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Azure Login via OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      - name: Get ACR name from Terraform outputs
        id: get_acr
        run: |
          RG_NAME="${{ env.APP_NAME }}-rg"
          
          ACR_NAME=$(az acr list --resource-group ${RG_NAME} --query "[0].name" -o tsv)
          echo "acr_name=$ACR_NAME" >> $GITHUB_OUTPUT
          echo "resource_group=$RG_NAME" >> $GITHUB_OUTPUT
          echo "ACR Name: $ACR_NAME"
          echo "Resource Group: $RG_NAME"
      
      - name: Login to Azure Container Registry
        run: |
          az acr login --name ${{ steps.get_acr.outputs.acr_name }}
      
      - name: Build and push Docker image
        working-directory: ./API/People
        run: |
          ACR_LOGIN_SERVER="${{ steps.get_acr.outputs.acr_name }}.azurecr.io"
          IMAGE_TAG="${{ github.sha }}"
          
          docker build -t ${ACR_LOGIN_SERVER}/go-backend:${IMAGE_TAG} .
          docker build -t ${ACR_LOGIN_SERVER}/go-backend:latest .
          
          docker push ${ACR_LOGIN_SERVER}/go-backend:${IMAGE_TAG}
          docker push ${ACR_LOGIN_SERVER}/go-backend:latest
      
      - name: Update Web App with new image
        run: |
          ACR_LOGIN_SERVER="${{ steps.get_acr.outputs.acr_name }}.azurecr.io"
          
          az webapp config container set \
            --name ${{ env.APP_NAME }}-go-backend \
            --resource-group ${{ steps.get_acr.outputs.resource_group }} \
            --docker-custom-image-name ${ACR_LOGIN_SERVER}/go-backend:${{ github.sha }}
      
      - name: Set Dynamic App Settings (Secrets)
        run: |
          az webapp config appsettings set \
            --name ${{ env.APP_NAME }}-go-backend \
            --resource-group ${{ steps.get_acr.outputs.resource_group }} \
            --settings MONGODB_URI="${{ secrets.MONGODB_URI }}"
      
      - name: Restart Web App
        run: |
          az webapp restart \
            --name ${{ env.APP_NAME }}-go-backend \
            --resource-group ${{ steps.get_acr.outputs.resource_group }}
      
      - name: Verify Deployment
        run: |
          echo "Deployment completed. Checking app status..."
          sleep 15
          
          az webapp show \
            --name ${{ env.APP_NAME }}-go-backend \
            --resource-group ${{ steps.get_acr.outputs.resource_group }} \
            --query "state" -o tsv